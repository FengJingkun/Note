**数据链路层在互联同一链路的节点间进行通信传输。其中，MAC地址用于识别数据链路中互联的节点。**

对于处于不同数据链路的节点，则需要借助网络层进行通信传输，即**点对点通信**。

- **主机：**配置有IP地址，但不进行路由控制的设备
- **节点：**主机和路由器的统称

**在传输过程中，源IP和目的IP是不变的，只有源MAC和目的MAC在一直变化。**

<br>

## IP地址分类

IP地址由32位正整数表示，由网络号和主机号两部分组成。其中，不同的数据链路段拥有不同的网络号，位于同一链路的主机网络号相同，但主机号不同。这样就保证了IP地址的**唯一性**。

- **A类地址：**网络号8位，0开头，24位主机号；
- **B类地址：**网络号16位，10开头，16位主机号；
- **C类地址：**网络号24位，110开头，8位主机号；
- **D类地址：**网络号32位，1110开头，无主机号，常用于多播。

**主机号的二进制位不能全为0或1，全为0时代表某个网络，全为1时为广播地址。**

<br>

### 广播地址

广播地址用于在**同一链路中相互连接的主机间发送数据包**。广播地址又分为本地广播和直接广播两种。

- 本地广播的IP包会被路由器屏蔽，因此只能在当前链路上传递；
- 直接广播的IP包可在不同网络间传递，因此可向其它网络上的所有主机发送数据包。

然而，广播会将数据发送给所有终端主机，由主机上层判断是否需要接收该数据，从而产生不必要的流量。

另外，直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发。

<br>

### IP多播

多播用于**将包发送给特定组内的所有主机**，使用D类IP地址。其中，后28位用于组成多播的组编号。

多播的IP包会由路由器转发，因此可向其它网段发送数据。此外，通过组编号向同组主机发送数据包，避免流量浪费。

<br>

### IP分类缺点

- **同一网络下无法划分地址层次**
- **与现实无法匹配，AB类地址包含的主机数量过多，C类又过少**

<br>

### 子网掩码

在主机号中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。掩码的意思是掩盖掉主机号，剩余的就是网络号。

**将子网掩码与IP地址进行按位与，就可得到网络号。**

>  若IP地址前20位是网络号，则子网掩码的前20位均为1。

**划分子网：IP地址 = 网络号 + 子网号 + 主机号**

> 对C类地址划分子网，若子网掩码前26位为1，则IP地址 = 网络号(24位) + 子网号(2位) + 主机号(6位)，即划分为4个子网，从而实现**同一网络地址层次的划分**。

<br>

### 无分类地址CIDR

消除传统A类，B类，C类及子网划分的概念，使用网络前缀 + 主机号来划分IP地址。

IP地址划分为网络号 + 主机号，表示为**a.b.c.d/x**，其中前x位表示网络号。CIDR地址掩码与子网掩码实际上是一个概念。

<br>

<br>

## IP路由控制

IP地址的网络号用于路由控制。主机和路由器有各自的路由控制表，记录着网络地址与下一步应该发送至的路由器地址。

发送IP包时，首先确定IP首部的目标地址D，查找路由控制表匹配与D相同的记录，然后决定下一跳的路由地址。若存在多条匹配记录，则选择相同位数最多的网络地址进行传递。

<br>

## IP分片与重组

不同的数据链路具有不同的最大传输单元MTU，即不同链路支持的单次传输的最大字节数不同。因此，当IP包的大小超过MTU时就会被分片。

**分片后的IP数据包仅在目标主机进行重组，路由器仅进行转发。若某个IP分片丢失，则会导致整个IP数据报的作废。因此TCP引入MSS，将分片转移至传输层进行，从而避免IP分片。**对于UDP，应尽量不发送大于一个MTU的数据报文。

<br>

## IP首部

IP数据报为首部 + 数据的格式。其中首部分为固定部分（20字节）和可变部分（4字节）。

### 固定部分

- **版本：**4比特位，区分是IPV4还是IPV6

- **首部长度：**4比特位，表明IP首部的大小，若首部无可变部分，则设置为5，即20字节

- **区分服务：**8比特位，用于表明服务质量，一般情况下不使用

- **总长度：**16比特位，整个IP数据报的长度，包括首部 + 数据

  

- **标识：**16比特位，IP报发生分片时，同一数据报的不同分片具有同样的标识

- **标志位：**3比特位，表示包分片的相关信息(是否分片，是否是分片的最后一个包等)

- **片偏移：**13比特位，标识被分片的每一个分段相对原始数据的位置

  

- **生存时间Time To Live(TTL)：**8比特，以路由器跳数为单位，每中转一个路由器就减1，减至0时丢弃

- **协议：** 8比特，指出IP包应交给哪个协议处理，如ICMP，TCP，UDP等

- **首部校验和：**16比特，确保IP首部不被破坏

  

- **源地址：**32比特，发送端IP地址

- **目的地址：**32比特，接收端IP地址

<br>

### 可变部分

分为可选项和填充两部分，可选项在进行实验或诊断时使用，包含源路径，安全级别，路径记录等信息；填充部分负责将首部长度填充至32比特位的整数倍。