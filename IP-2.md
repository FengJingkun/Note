## IP相关协议

仅凭IP协议无法完成通信，还必须需要能够解析主机名称和MAC地址的功能，以及数据包发送过程中的异常处理功能。

<br>

## DNS

域名解析，将域名网址自动转换为具体的IP地址。

### 域名的层级关系

DNS中的域名以句点分割，如www.server.com，句点表示不同层次的界限。**越靠右，层级越高。**

域名的层级关系可看作一个树结构：

- **根域DNS服务器**
- **顶级域DNS服务器：**com, cn ...
- **权威DNS服务器：**server.com, google.com ...

<br>

### 域名解析

浏览器依次查看浏览器缓存 --> OS缓存 --> 本地域名解析hosts文件，若未找到，则向DNS服务器进行查询。

1. 客户端根据客户端TCP/IP设置中填写的DNS服务器地址，向DNS服务器发请求；
2. 若本地DNS服务器的缓存未找到，则向根域DNS服务器发请求；
3. 根域DNS服务器发现顶级域是com，则返回顶级域com服务器的地址；
4. 本地DNS服务器向顶级域发请求，后者发现权威域是google.com，则返回权威域服务器的地址；
5. 本地DNS服务器向权威域发请求，后者查询后返回对应的IP地址；
6. 本地DNS服务器返回至客户端，并记录至缓存

<br>

<br>

## ARP

网络层实现主机间通信，数据链路层实现具体每段链路间的通信。IP数据包传输时，通过路由表确定下一跳的IP地址。明确下一跳的IP地址后，数据链路层还需要知道下一跳的MAC地址，才能进行具体的传输。

**地址解析协议ARP实现由IP地址得到MAC地址，具体工作通过ARP请求与响应来完成。**

1. 主机通过路由表查询到下一跳的IP地址后，**广播发送ARP请求**，请求包中包含了下一跳的IP地址；
2. 当前链路的所有设备收到ARP请求后进行解析，若ARP请求包中的IP地址与自己的IP地址一致，就将包含自己MAC地址的ARP响应包返回给主机。

OS通常将第一次通过ARP获取的MAC地址缓存起来，但MAC地址的缓存是有一定期限的，超期则被清除。

<br>

### RARP

**已知MAC地址，求IP地址。**将打印机服务器等小型嵌入式设备接入网络时会用到该协议。

设备向RARP服务器发送包含自己MAC地址的请求信息，随后根据RARP的返回信息设置自己的IP地址。

<br>

<br>

## ICMP

ICMP全程是Internet Control Message Protocol，即**互联网控制报文协议**。

**ICMP封装在IP报文包的数据部分，但不属于高层协议。**

ICMP的主要功能包括：**确认IP包是否成功送达目标地址，报告发送过程中IP包被遗弃的原因等。**

如果某个IP包因为某种原因未到达目的地址，那么这个原因由ICMP负责通知，通知消息使用IP发送。

> IP报文传输至路由器B，路由器B发送ARP广播查找下一跳IP的MAC地址。然而下一跳的主机处于关闭状态，B未收到ARP响应，无法到达下一跳，于是返回一个ICMP Destination Unreachable的包给源主机。

ICMP的消息可分为两类：一类是**通知出错原因的差错报告报文**；一类是**用于诊断的查询报文**。

<br>

### 差错报告报文

- **目标不可达**
- **超时：**TTL减至0时，路由器将IP包丢弃，并返回ICMP超时报文。
- **重定向：**路由器发现IP传输未使用最优路径，则返回包含最优路径的重定向ICMP报文。(通常不使用)

<br>

### 查询报文

- **回送消息(Echo请求或回答)：**判断发送的数据包是否成功到达对端的一种消息。发送端发送Echo请求消息，对端接收后返回Echo应答消息。
- **时间戳Timestamp请求或回答**

<br>

### ICMP应用

#### Ping

源主机向目标主机发送**ICMP查询报文(Echo请求)**，目标主机收到后回答该报文**(Echo应答)**。Ping根据时间和成功响应的次数估算数据包的往返时间和丢包率。

#### Traceroute

**Traceroute跟踪数据包从源主机到目的主机的路径。**

Traceroute在IP数据包封装**无法交付的UDP数据报**，然后利用IP包的生存期限，从TTL为1开始，按照顺序递增的方式发送UDP包，直至最后一个IP包到达目标主机。

路径上的每个节点都会收到一个TTL减至0的IP报文，因此会向源主机返回**ICMP超时报文**；由于IP包封装了无法交付的UDP数据，因此目标主机将返回一个**ICMP终点不可达报文**。最后，源主机通过这些**ICMP差错控制报文**来了解传输路径上的节点IP地址以及到达每个节点的往返时间。

<br>

<br>

## DHCP

设备通过DHCP动态获取IP地址，省去了配置IP信息的繁琐过程。

### 工作机制

使用DHCP前需要架设DHCP服务器，通常由路由器充当该角色。

1. 客户端首先**广播**发送**DHCP发现报文**的IP数据报，其使用的目的地址为广播地址，源地址为0.0.0.0；
2. DHCP服务器收到报文后，**广播**响应**DHCP提供报文**的IP数据报，该报文携带服务器提供的IP地址，子网掩码，默认网关，DNS服务器，以及**IP租约**等信息；
3. 客户端收到一个或多个DHCP提供报文后，向选中的服务器发送**DHCP请求报文**，通知服务器自己想要使用的IP地址，参数等配置；
4. 服务器返回**DHCP ACK报文**，表示客户端可以使用该地址及参数。

当租约的IP地址到期后，客户端会向服务器发送DHCP请求报文：

- 若服务器同意客户端继续使用当前IP，则返回DHCP ACK报文；
- 若不同意，则返回DHCP NACK报文。

**DHCP交互中，全程都是使用UDP广播通信。**

<br>

### 中继代理

若DHCP服务器和客户端不在同一条链路上，路由器又不会转发广播包，那就需要每个网络都配置一个DHCP服务器。

为了解决该问题，引入**DHCP中继代理**。**对不同网段的IP地址分配，都可以由一个DHCP服务器统一管理**。

1. DHCP客户端向DHCP中继代理广播发送**DHCP请求包**，后者收到广播包后，**单播**发给DHCP服务器；
2. DHCP服务器返回应答后，再由中继代理**广播**发送给客户端。

<br>

<br>

## NAT

专业网内部的主机使用私有IP地址，在连接互联网时则需要使用公有IP，使用NAT可将私有地址转换为公有地址。

NAT转换表记录私有地址与公有地址的映射关系。在地址转换时，通常也会使用传输层的端口号，这就可以让多个专用网内部的主机共用一个IP公有地址，即NAPT。